<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¡œì»¬ LLM ìš”ì•½ ë°ëª¨ | Local Ollama Integration</title>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-light: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #475569;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    /* Status Section */
    .status-section {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .status-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .status-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .status-indicator.checking {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .status-indicator.connected {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    .status-indicator.disconnected {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-indicator.checking .status-dot {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .models-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .model-tag {
      background: var(--surface-light);
      padding: 0.3rem 0.7rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-family: 'Fira Code', monospace;
    }

    .model-tag.recommended {
      background: rgba(99, 102, 241, 0.2);
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    /* Error Guide */
    .error-guide {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .error-guide h4 {
      color: var(--error);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .error-guide code {
      display: block;
      background: var(--bg);
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.8rem;
      margin-top: 0.5rem;
      overflow-x: auto;
    }

    /* Main Card */
    .main-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    /* Input */
    .input-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.95rem;
      line-height: 1.6;
      resize: vertical;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    textarea::placeholder {
      color: var(--text-muted);
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .model-select, .context-select, .think-select {
      flex: 1;
      min-width: 130px;
    }

    .button-group {
      display: flex;
      gap: 0.5rem;
    }

    select {
      width: 100%;
      padding: 0.7rem 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .btn {
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--surface-light);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    /* Output */
    .output-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .output-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .output-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .stats {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-family: 'Fira Code', monospace;
    }

    .output-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      min-height: 100px;
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.7;
    }

    .output-box.streaming {
      border-color: var(--primary);
    }

    .cursor {
      display: inline-block;
      width: 2px;
      height: 1.2em;
      background: var(--primary);
      margin-left: 2px;
      vertical-align: text-bottom;
      animation: blink 0.8s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .placeholder-text {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Info Section */
    .info-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--surface);
      border-radius: 12px;
    }

    .info-section h3 {
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .info-item {
      background: var(--bg);
      padding: 1rem;
      border-radius: 8px;
    }

    .info-item h4 {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .info-item p {
      font-size: 0.9rem;
    }

    .info-item code {
      background: var(--surface-light);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    /* Mobile */
    @media (max-width: 640px) {
      body {
        padding: 1rem;
      }

      h1 {
        font-size: 1.4rem;
      }

      .controls {
        flex-direction: column;
      }

      .model-select {
        width: 100%;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ§  ë¡œì»¬ LLM ìš”ì•½ ë°ëª¨</h1>
      <p class="subtitle">ì™¸ë¶€ ì„œë²„ ì—†ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ë¡œì»¬ Ollama í˜¸ì¶œ</p>
    </header>

    <!-- Status Section -->
    <section class="status-section">
      <div class="status-header">
        <span class="status-title">Ollama ì—°ê²° ìƒíƒœ</span>
        <div id="status-indicator" class="status-indicator checking">
          <span class="status-dot"></span>
          <span id="status-text">í™•ì¸ ì¤‘...</span>
        </div>
      </div>
      <div id="status-details"></div>
    </section>

    <!-- Main Card -->
    <section class="main-card">
      <h2 class="card-title">í…ìŠ¤íŠ¸ ìš”ì•½</h2>

      <div class="input-group">
        <label for="input-text">ìš”ì•½í•  í…ìŠ¤íŠ¸</label>
        <textarea
          id="input-text"
          placeholder="ì—¬ê¸°ì— ìš”ì•½í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.

ì˜ˆì‹œ: í™˜ì ìƒë‹´ ê¸°ë¡, ì˜í•™ ë…¼ë¬¸ ì´ˆë¡, ë‰´ìŠ¤ ê¸°ì‚¬ ë“±

â€» ì…ë ¥í•œ ë°ì´í„°ëŠ” ì™¸ë¶€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
   ì˜¤ì§ ë¡œì»¬ PCì˜ Ollamaë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤."
        ></textarea>
      </div>

      <div class="controls">
        <div class="model-select">
          <label for="model-select" style="margin-bottom: 0.3rem;">ëª¨ë¸</label>
          <select id="model-select">
            <option value="">ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>
        <div class="context-select">
          <label for="context-select" style="margin-bottom: 0.3rem;">ì»¨í…ìŠ¤íŠ¸</label>
          <select id="context-select">
            <option value="8192">8K (ì €ì‚¬ì–‘)</option>
            <option value="16384">16K</option>
            <option value="32768" selected>32K (ê¶Œì¥)</option>
            <option value="65536">64K (12GB+)</option>
            <option value="131072">128K (16GB+)</option>
          </select>
        </div>
        <div class="think-select">
          <label for="think-select" style="margin-bottom: 0.3rem;">Thinking</label>
          <select id="think-select">
            <option value="think" selected>ğŸ§  Think (ê³ í’ˆì§ˆ)</option>
            <option value="no_think">âš¡ No Think (ë¹ ë¦„)</option>
          </select>
        </div>
        <div class="button-group">
          <button id="summarize-btn" class="btn btn-primary" disabled>
            <span>âœ¨</span> ìš”ì•½í•˜ê¸°
          </button>
          <button id="clear-btn" class="btn btn-secondary">
            ì§€ìš°ê¸°
          </button>
        </div>
      </div>

      <div id="output-section" class="output-section" style="display: none;">
        <div class="output-header">
          <span class="output-title">ìš”ì•½ ê²°ê³¼</span>
          <span id="stats" class="stats"></span>
        </div>
        <div id="output-box" class="output-box">
          <span class="placeholder-text">ìš”ì•½ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</span>
        </div>
      </div>
    </section>

    <!-- Info Section -->
    <section class="info-section">
      <h3>ğŸ“‹ ì„¤ì • ê°€ì´ë“œ</h3>
      <div class="info-grid">
        <div class="info-item">
          <h4>1. Ollama ì„¤ì¹˜</h4>
          <p><a href="https://ollama.com" target="_blank">ollama.com</a>ì—ì„œ ì„¤ì¹˜</p>
        </div>
        <div class="info-item">
          <h4>2. ëª¨ë¸ ë‹¤ìš´ë¡œë“œ</h4>
          <p><code>ollama pull qwen3:8b</code></p>
        </div>
        <div class="info-item">
          <h4>3. CORS ì„¤ì • (Windows)</h4>
          <p>PowerShell ê´€ë¦¬ì:<br><code>setx OLLAMA_ORIGINS "*"</code></p>
        </div>
        <div class="info-item">
          <h4>4. Ollama ì¬ì‹œì‘</h4>
          <p>íŠ¸ë ˆì´ ì•„ì´ì½˜ì—ì„œ ì¢…ë£Œ í›„ ë‹¤ì‹œ ì‹¤í–‰</p>
        </div>
      </div>
    </section>

    <!-- Security Warning Section -->
    <section class="info-section" style="border: 1px solid rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05);">
      <h3>ğŸ”’ í…ŒìŠ¤íŠ¸ í›„ CORS ë¹„í™œì„±í™” (ë³´ì•ˆ)</h3>
      <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
        CORSë¥¼ ì—´ì–´ë‘ë©´ ì•…ì„± ì›¹ì‚¬ì´íŠ¸ë„ ë¡œì»¬ Ollamaì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ í›„ì—ëŠ” ì„¤ì •ì„ í•´ì œí•˜ì„¸ìš”.
      </p>
      <div class="info-grid">
        <div class="info-item">
          <h4>Windows - ë¹„í™œì„±í™”</h4>
          <p style="font-size: 0.85rem;">PowerShell ê´€ë¦¬ì:</p>
          <code style="font-size: 0.75rem; display: block; margin-top: 0.5rem; background: var(--surface); padding: 0.5rem; border-radius: 4px;">reg delete "HKCU\Environment" /v OLLAMA_ORIGINS /f</code>
        </div>
        <div class="info-item">
          <h4>macOS / Linux - ë¹„í™œì„±í™”</h4>
          <p style="font-size: 0.85rem;">~/.zshrcì—ì„œ ì‚­ì œ:</p>
          <code style="font-size: 0.75rem; display: block; margin-top: 0.5rem; background: var(--surface); padding: 0.5rem; border-radius: 4px;"># export OLLAMA_ORIGINS="*"</code>
        </div>
      </div>
      <p style="color: var(--warning); font-size: 0.85rem; margin-top: 1rem;">
        ğŸ’¡ ìì£¼ ì‚¬ìš©í•œë‹¤ë©´ <code>OLLAMA_ORIGINS="https://ì‹ ë¢°í• ìˆ˜ìˆëŠ”ì‚¬ì´íŠ¸.com"</code>ì²˜ëŸ¼ íŠ¹ì • ë„ë©”ì¸ë§Œ í—ˆìš©í•˜ì„¸ìš”.
      </p>
    </section>

    <!-- Deployment Troubleshooting Section -->
    <section class="info-section" style="border: 1px solid rgba(99, 102, 241, 0.3); background: rgba(99, 102, 241, 0.05);">
      <h3>ğŸš€ ë°°í¬ í™˜ê²½ì—ì„œ ì—°ê²° ì•ˆ ë  ë•Œ (Chrome 124+)</h3>
      <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
        Chrome 124+ ë²„ì „ì€ ë³´ì•ˆ ì •ì±…(PNA)ìœ¼ë¡œ HTTPS â†’ localhost ì—°ê²°ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.<br>
        <code style="font-size: 0.8rem;">Permission was denied for this request to access the 'loopback' address space</code>
      </p>

      <div class="info-item" style="background: var(--bg); margin-bottom: 1rem;">
        <h4>âœ… í•´ê²°: Chrome íŠ¹ìˆ˜ ëª¨ë“œë¡œ ì‹¤í–‰</h4>
        <p style="font-size: 0.85rem; margin-bottom: 0.5rem;">1. Chromeì„ ì™„ì „íˆ ì¢…ë£Œ (ì‹œìŠ¤í…œ íŠ¸ë ˆì´ í¬í•¨)</p>
        <p style="font-size: 0.85rem; margin-bottom: 0.5rem;">2. ì•„ë˜ ëª…ë ¹ì–´ë¡œ Chrome ì‹¤í–‰:</p>
        <code style="font-size: 0.7rem; display: block; margin-top: 0.5rem; background: var(--surface); padding: 0.75rem; border-radius: 4px; word-break: break-all; line-height: 1.6;">"C:\Program Files\Google\Chrome\Application\chrome.exe" --disable-features=BlockInsecurePrivateNetworkRequests,PrivateNetworkAccessSendPreflights --disable-web-security --user-data-dir="C:\temp\chrome-dev"</code>
        <p style="font-size: 0.8rem; color: var(--warning); margin-top: 0.75rem;">
          âš ï¸ ì´ ëª¨ë“œëŠ” ë³´ì•ˆì´ ë¹„í™œì„±í™”ë˜ë¯€ë¡œ, Ollama í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
        </p>
      </div>

      <div class="info-item" style="background: var(--bg);">
        <h4>ğŸ“ ë°”ë¡œê°€ê¸° ë§Œë“¤ê¸° (í¸ì˜ìš©)</h4>
        <ol style="font-size: 0.8rem; margin: 0.5rem 0 0 1rem; color: var(--text-muted);">
          <li>ë°”íƒ•í™”ë©´ ìš°í´ë¦­ â†’ ìƒˆë¡œ ë§Œë“¤ê¸° â†’ ë°”ë¡œê°€ê¸°</li>
          <li>ìœ„ ëª…ë ¹ì–´ ì „ì²´ë¥¼ ë¶™ì—¬ë„£ê¸°</li>
          <li>ì´ë¦„: "Chrome (Ollama Dev)"</li>
        </ol>
      </div>

      <div class="info-grid" style="margin-top: 1rem;">
        <div class="info-item">
          <h4>OLLAMA_ORIGINS í™•ì¸</h4>
          <p style="font-size: 0.85rem;">í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í•„ìˆ˜:</p>
          <code style="font-size: 0.75rem; display: block; margin-top: 0.5rem; background: var(--surface); padding: 0.5rem; border-radius: 4px;">setx OLLAMA_ORIGINS "*"</code>
        </div>

        <div class="info-item">
          <h4>Ollama ì¬ì‹œì‘</h4>
          <p style="font-size: 0.85rem;">í™˜ê²½ ë³€ìˆ˜ ë³€ê²½ í›„:</p>
          <ol style="font-size: 0.8rem; margin: 0.5rem 0 0 1rem; color: var(--text-muted);">
            <li>íŠ¸ë ˆì´ì—ì„œ Ollama ì¢…ë£Œ</li>
            <li>Ollama ë‹¤ì‹œ ì‹¤í–‰</li>
          </ol>
        </div>
      </div>
    </section>

    <footer>
      <p>
        ì´ ë°ëª¨ëŠ” <code>https</code> í˜ì´ì§€ì—ì„œ <code>http://localhost:11434</code>ë¡œ ì§ì ‘ í†µì‹ í•©ë‹ˆë‹¤.<br>
        Chrome/Edge ê¶Œì¥ (Safari ë¯¸ì§€ì›)
      </p>
    </footer>
  </div>

  <script>
    // ============================================================
    // Configuration
    // ============================================================
    const OLLAMA_URL = 'http://localhost:11434';
    const RECOMMENDED_MODELS = ['qwen3:8b', 'qwen3:7b', 'qwen3:4b', 'qwen2.5:7b', 'qwen2.5:3b'];

    // ============================================================
    // DOM Elements
    // ============================================================
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const statusDetails = document.getElementById('status-details');
    const modelSelect = document.getElementById('model-select');
    const contextSelect = document.getElementById('context-select');
    const thinkSelect = document.getElementById('think-select');
    const inputText = document.getElementById('input-text');
    const summarizeBtn = document.getElementById('summarize-btn');
    const clearBtn = document.getElementById('clear-btn');
    const outputSection = document.getElementById('output-section');
    const outputBox = document.getElementById('output-box');
    const stats = document.getElementById('stats');

    // ============================================================
    // State
    // ============================================================
    let isConnected = false;
    let isStreaming = false;
    let abortController = null;

    // ============================================================
    // Ollama API Functions
    // ============================================================

    /**
     * Ollama ì—°ê²° ìƒíƒœ ë° ì„¤ì¹˜ëœ ëª¨ë¸ í™•ì¸
     */
    async function checkOllamaStatus() {
      try {
        const response = await fetch(`${OLLAMA_URL}/api/tags`, {
          method: 'GET',
          signal: AbortSignal.timeout(5000)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        const models = data.models?.map(m => m.name) || [];

        return {
          connected: true,
          models: models,
          error: null
        };

      } catch (error) {
        let errorType = 'unknown';
        let errorMessage = 'Ollama ì—°ê²° ì‹¤íŒ¨';

        if (error.name === 'AbortError' || error.name === 'TimeoutError') {
          errorType = 'not_running';
          errorMessage = 'Ollamaê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤';
        } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
          // CORS ì—ëŸ¬ë„ ì´ìª½ìœ¼ë¡œ ì˜´
          errorType = 'cors_or_not_running';
          errorMessage = 'Ollama ë¯¸ì‹¤í–‰ ë˜ëŠ” CORS ì„¤ì • í•„ìš”';
        }

        return {
          connected: false,
          models: [],
          error: errorMessage,
          errorType: errorType
        };
      }
    }

    /**
     * ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ ìš”ì•½ ìš”ì²­
     */
    async function summarizeText(text, model, numCtx, thinkMode, onChunk, onComplete, onError) {
      abortController = new AbortController();

      const systemPrompt = `ë‹¹ì‹ ì€ í•œêµ­ì–´ ìš”ì•½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì£¼ì–´ì§„ í…ìŠ¤íŠ¸ë¥¼ í•µì‹¬ ë‚´ìš© ìœ„ì£¼ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•˜ì„¸ìš”.
- í•œêµ­ì–´ë¡œ ë‹µë³€
- 3-5ë¬¸ì¥ ì´ë‚´
- í•µì‹¬ ì •ë³´ë§Œ í¬í•¨
- ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´ ì œì™¸`;

      // ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ êµ¬ì„±
      let userPrompt = `[í…ìŠ¤íŠ¸]\n${text}\n\n[ìš”ì•½]`;
      if (thinkMode === 'no_think') {
        userPrompt += ' /no_think';
      }

      // /api/chat ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš© (ë” ì•ˆì •ì ì¸ ì˜µì…˜ ì ìš©)
      const requestBody = {
        model: model,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt }
        ],
        stream: true,
        options: {
          temperature: 0.3,
          num_ctx: numCtx,
          num_predict: -1  // -1 = ë¬´ì œí•œ (ì»¨í…ìŠ¤íŠ¸ ë‚´ì—ì„œ)
        }
      };

      const startTime = performance.now();
      let tokenCount = 0;

      try {
        const response = await fetch(`${OLLAMA_URL}/api/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody),
          signal: abortController.signal
        });

        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('MODEL_NOT_FOUND');
          }
          throw new Error(`HTTP_${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let fullResponse = '';
        let buffer = ''; // ë¶ˆì™„ì „í•œ ì²­í¬ë¥¼ ì €ì¥í•  ë²„í¼
        let isInsideThinkBlock = false; // <think> ë¸”ë¡ ë‚´ë¶€ì¸ì§€ ì¶”ì 

        while (true) {
          const { done, value } = await reader.read();

          if (done) break;

          // 1. ë²„í¼ì— ìƒˆë¡œìš´ ë°ì´í„° ì¶”ê°€
          buffer += decoder.decode(value, { stream: true });

          // 2. ì¤„ë°”ê¿ˆ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
          const lines = buffer.split('\n');

          // 3. ë§ˆì§€ë§‰ ì¡°ê°ì€ ë¶ˆì™„ì „í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë²„í¼ì— ë‚¨ê²¨ë‘ 
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.trim() === '') continue;
            try {
              const json = JSON.parse(line);

              if (json.message && json.message.content) {
                // Qwen3 <think> íƒœê·¸ í•„í„°ë§ (thinking ëª¨ë“œ ì¶œë ¥ ì œê±°)
                let cleanResponse = json.message.content;

                // <think> ë¸”ë¡ ì‹œì‘ ê°ì§€
                if (cleanResponse.includes('<think>')) {
                  isInsideThinkBlock = true;
                  cleanResponse = cleanResponse.replace(/<think>/g, '');
                }

                // <think> ë¸”ë¡ ì¢…ë£Œ ê°ì§€
                if (cleanResponse.includes('</think>')) {
                  isInsideThinkBlock = false;
                  cleanResponse = cleanResponse.replace(/<\/think>/g, '');
                }

                // think ë¸”ë¡ ë‚´ë¶€ë©´ ì¶œë ¥ ìŠ¤í‚µ
                if (isInsideThinkBlock) continue;

                // ë¹ˆ ì‘ë‹µì´ë©´ ìŠ¤í‚µ
                if (cleanResponse.trim() === '') continue;

                fullResponse += cleanResponse;
                tokenCount++;
                onChunk(cleanResponse, fullResponse);
              }

              if (json.done === true) {
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
                onComplete(fullResponse, {
                  tokens: tokenCount,
                  elapsed: elapsed,
                  tokensPerSec: (tokenCount / parseFloat(elapsed)).toFixed(1)
                });
              }
            } catch (parseError) {
              console.warn('JSON parsing skipped (incomplete chunk):', line.substring(0, 50));
            }
          }
        }

        // ë£¨í”„ ì¢…ë£Œ í›„ ë²„í¼ì— ë‚¨ì€ ë°ì´í„° ì²˜ë¦¬
        if (buffer.trim()) {
          try {
            const json = JSON.parse(buffer);
            if (json.message && json.message.content) {
              fullResponse += json.message.content;
              tokenCount++;
              onChunk(json.message.content, fullResponse);
            }
          } catch (e) {
            // ë¬´ì‹œ
          }
        }

      } catch (error) {
        if (error.name === 'AbortError') {
          onError({ type: 'cancelled', message: 'ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤' });
        } else if (error.message === 'MODEL_NOT_FOUND') {
          onError({
            type: 'model_not_found',
            message: `ëª¨ë¸ '${model}'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`,
            action: `í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰: ollama pull ${model}`
          });
        } else {
          onError({
            type: 'unknown',
            message: error.message
          });
        }
      }
    }

    // ============================================================
    // UI Update Functions
    // ============================================================

    function updateStatusUI(status) {
      isConnected = status.connected;

      if (status.connected) {
        statusIndicator.className = 'status-indicator connected';
        statusText.textContent = 'ì—°ê²°ë¨';

        // ëª¨ë¸ ëª©ë¡ í‘œì‹œ
        if (status.models.length > 0) {
          const modelsHtml = status.models.map(m => {
            const isRecommended = RECOMMENDED_MODELS.some(r => m.startsWith(r.replace(':latest', '')));
            return `<span class="model-tag ${isRecommended ? 'recommended' : ''}">${m}</span>`;
          }).join('');
          statusDetails.innerHTML = `<div class="models-list">${modelsHtml}</div>`;

          // ëª¨ë¸ ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
          updateModelSelect(status.models);
        }

        summarizeBtn.disabled = false;

      } else {
        statusIndicator.className = 'status-indicator disconnected';
        statusText.textContent = 'ì—°ê²° ì•ˆë¨';

        // ì—ëŸ¬ ê°€ì´ë“œ í‘œì‹œ
        statusDetails.innerHTML = `
          <div class="error-guide">
            <h4>âš ï¸ ${status.error}</h4>
            <p>ë‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:</p>
            <ol style="margin: 0.5rem 0 0 1.2rem; color: var(--text-muted); font-size: 0.85rem;">
              <li>Ollamaê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸</li>
              <li>CORS í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸</li>
            </ol>
            <code>
# Windows PowerShell (ê´€ë¦¬ì)
setx OLLAMA_ORIGINS "*"
# ê·¸ í›„ Ollama ì¬ì‹œì‘
            </code>
          </div>
        `;

        summarizeBtn.disabled = true;
      }
    }

    function updateModelSelect(models) {
      modelSelect.innerHTML = '<option value="">ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”</option>';

      // ì¶”ì²œ ëª¨ë¸ ìš°ì„  ì •ë ¬
      const sortedModels = [...models].sort((a, b) => {
        const aRecommended = RECOMMENDED_MODELS.some(r => a.includes(r.split(':')[0]));
        const bRecommended = RECOMMENDED_MODELS.some(r => b.includes(r.split(':')[0]));
        if (aRecommended && !bRecommended) return -1;
        if (!aRecommended && bRecommended) return 1;
        return 0;
      });

      sortedModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        const isRecommended = RECOMMENDED_MODELS.some(r => model.includes(r.split(':')[0]));
        option.textContent = isRecommended ? `â­ ${model}` : model;
        modelSelect.appendChild(option);
      });

      // ì²« ë²ˆì§¸ ì¶”ì²œ ëª¨ë¸ ìë™ ì„ íƒ
      const firstRecommended = sortedModels.find(m =>
        RECOMMENDED_MODELS.some(r => m.includes(r.split(':')[0]))
      );
      if (firstRecommended) {
        modelSelect.value = firstRecommended;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showOutput(text, streaming = false) {
      outputSection.style.display = 'block';
      outputBox.className = `output-box ${streaming ? 'streaming' : ''}`;
      // HTML íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
      const safeText = escapeHtml(text);
      outputBox.innerHTML = safeText + (streaming ? '<span class="cursor"></span>' : '');
    }

    function showStats(statsData, numCtx, thinkMode) {
      const ctxLabel = numCtx >= 1024 ? `${numCtx / 1024}K` : numCtx;
      const thinkLabel = thinkMode === 'think' ? 'ğŸ§ ' : 'âš¡';
      stats.textContent = `${statsData.tokens} tokens Â· ${statsData.elapsed}s Â· ${statsData.tokensPerSec} t/s Â· ctx: ${ctxLabel} ${thinkLabel}`;
    }

    function resetOutput() {
      outputSection.style.display = 'none';
      outputBox.innerHTML = '<span class="placeholder-text">ìš”ì•½ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</span>';
      stats.textContent = '';
    }

    // ============================================================
    // Event Handlers
    // ============================================================

    summarizeBtn.addEventListener('click', async () => {
      const text = inputText.value.trim();
      const model = modelSelect.value;
      const numCtx = parseInt(contextSelect.value, 10);
      const thinkMode = thinkSelect.value;

      if (!text) {
        alert('ìš”ì•½í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!model) {
        alert('ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      // UI ìƒíƒœ ë³€ê²½
      isStreaming = true;
      summarizeBtn.disabled = true;
      summarizeBtn.innerHTML = '<span>â³</span> ìš”ì•½ ì¤‘...';
      showOutput('', true);

      await summarizeText(
        text,
        model,
        numCtx,
        thinkMode,
        // onChunk
        (token, fullText) => {
          showOutput(fullText, true);
        },
        // onComplete
        (finalText, statsData) => {
          isStreaming = false;
          summarizeBtn.disabled = false;
          summarizeBtn.innerHTML = '<span>âœ¨</span> ìš”ì•½í•˜ê¸°';
          showOutput(finalText, false);
          showStats(statsData, numCtx, thinkMode);
        },
        // onError
        (error) => {
          isStreaming = false;
          summarizeBtn.disabled = false;
          summarizeBtn.innerHTML = '<span>âœ¨</span> ìš”ì•½í•˜ê¸°';
          outputBox.innerHTML = `<span style="color: var(--error);">âŒ ${error.message}</span>`;
          if (error.action) {
            outputBox.innerHTML += `<br><code style="margin-top: 0.5rem; display: block;">${error.action}</code>`;
          }
        }
      );
    });

    clearBtn.addEventListener('click', () => {
      if (isStreaming && abortController) {
        abortController.abort();
      }
      inputText.value = '';
      resetOutput();
    });

    // ============================================================
    // Initialize
    // ============================================================

    async function init() {
      const status = await checkOllamaStatus();
      updateStatusUI(status);

      // 5ì´ˆë§ˆë‹¤ ìƒíƒœ ì²´í¬ (ì—°ê²° ì•ˆ ëì„ ë•Œë§Œ)
      setInterval(async () => {
        if (!isConnected && !isStreaming) {
          const status = await checkOllamaStatus();
          updateStatusUI(status);
        }
      }, 5000);
    }

    init();
  </script>
</body>
</html>
